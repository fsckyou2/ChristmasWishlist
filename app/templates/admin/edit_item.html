{% extends "base.html" %}

{% block title %}Edit Item (Admin){% endblock %}

{% block head %}
<script src="{{ url_for('static', filename='js/image-selector.js') }}?v=4400"></script>
{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto">
    <h1 class="text-4xl font-bold mb-8">Edit Item (Admin)</h1>

    <div class="bg-gray-800 rounded-lg shadow-lg p-8">
        <div class="mb-4 p-4 bg-yellow-900 rounded">
            <p class="text-sm text-gray-200">
                <strong>Admin Mode:</strong> You are editing this item as an administrator.
            </p>
            <p class="text-xs text-gray-300 mt-2">
                Owner: {{ item.user.name if item.user else item.proxy_wishlist.name }}
            </p>
        </div>

        <form method="POST" class="space-y-4">
            {{ form.hidden_tag() }}

            <div>
                {{ form.url.label(class="block text-gray-200 font-semibold mb-2") }}
                <div class="flex gap-2">
                    {{ form.url(class="flex-1 px-4 py-2 bg-gray-700 border border-gray-600 text-gray-100 rounded-lg focus:ring-2 focus:ring-red-600 focus:border-red-600 placeholder-gray-400", id="url-input") }}
                    <button type="button" id="scrape-url-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 whitespace-nowrap">
                        Scrape URL
                    </button>
                </div>
                {% if form.url.errors %}
                    <p class="text-red-600 text-sm mt-1">{{ form.url.errors[0] }}</p>
                {% endif %}
                <p class="text-xs text-gray-400 mt-1">
                    Click "Scrape URL" to automatically fill fields from the product page.
                </p>
            </div>

            <div>
                {{ form.name.label(class="block text-gray-200 font-semibold mb-2") }}
                {{ form.name(class="w-full px-4 py-2 bg-gray-700 border border-gray-600 text-gray-100 rounded-lg focus:ring-2 focus:ring-red-600 focus:border-red-600 placeholder-gray-400", required=true, id="name") }}
                {% if form.name.errors %}
                    <p class="text-red-600 text-sm mt-1">{{ form.name.errors[0] }}</p>
                {% endif %}
            </div>

            <div>
                {{ form.description.label(class="block text-gray-200 font-semibold mb-2") }}
                {{ form.description(class="w-full px-4 py-2 bg-gray-700 border border-gray-600 text-gray-100 rounded-lg focus:ring-2 focus:ring-red-600 focus:border-red-600 placeholder-gray-400", rows=3, id="description") }}
                {% if form.description.errors %}
                    <p class="text-red-600 text-sm mt-1">{{ form.description.errors[0] }}</p>
                {% endif %}
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    {{ form.price.label(class="block text-gray-200 font-semibold mb-2") }}
                    {{ form.price(class="w-full px-4 py-2 bg-gray-700 border border-gray-600 text-gray-100 rounded-lg focus:ring-2 focus:ring-red-600 focus:border-red-600 placeholder-gray-400", step="0.01", id="price") }}
                    {% if form.price.errors %}
                        <p class="text-red-600 text-sm mt-1">{{ form.price.errors[0] }}</p>
                    {% endif %}
                </div>

                <div>
                    {{ form.quantity.label(class="block text-gray-200 font-semibold mb-2") }}
                    {{ form.quantity(class="w-full px-4 py-2 bg-gray-700 border border-gray-600 text-gray-100 rounded-lg focus:ring-2 focus:ring-red-600 focus:border-red-600 placeholder-gray-400") }}
                    {% if form.quantity.errors %}
                        <p class="text-red-600 text-sm mt-1">{{ form.quantity.errors[0] }}</p>
                    {% endif %}
                </div>
            </div>

            <div>
                {{ form.image_url.label(class="block text-gray-200 font-semibold mb-2") }}
                {{ form.image_url(class="w-full px-4 py-2 bg-gray-700 border border-gray-600 text-gray-100 rounded-lg focus:ring-2 focus:ring-red-600 focus:border-red-600 placeholder-gray-400", id="image-input") }}
                {% if form.image_url.errors %}
                    <p class="text-red-600 text-sm mt-1">{{ form.image_url.errors[0] }}</p>
                {% endif %}
                <p class="text-xs text-gray-400 mt-1">
                    Enter an image URL manually or select from available images below.
                </p>
            </div>

            <!-- Image selector container -->
            <div id="image-selector-container"></div>

            <div class="flex gap-4">
                {{ form.submit(class="flex-1 bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 cursor-pointer") }}
                <a href="{{ url_for('admin.items') }}" class="flex-1 bg-gray-600 text-white py-3 rounded-lg font-semibold hover:bg-gray-700 text-center">
                    Cancel
                </a>
            </div>
        </form>
    </div>
</div>

<script>
// Initialize image selector with existing data
window.imageSelector = new ImageSelector('#image-selector-container');
window.imageSelector.init('#image-input');

// Load existing images if available
{% if item %}
const currentImageUrl = "{{ item.image_url | safe }}";
const availableImages = {{ item.get_available_images() | tojson }};
window.imageSelector.loadExisting(currentImageUrl, availableImages);
{% endif %}

// Handle scrape URL button
document.getElementById('scrape-url-btn').addEventListener('click', async function() {
    const urlInput = document.getElementById('url-input');
    const url = urlInput.value.trim();

    if (!url) {
        alert('Please enter a URL first');
        return;
    }

    // Disable button and show loading state
    const btn = this;
    const originalText = btn.textContent;
    btn.disabled = true;
    btn.textContent = 'Scraping...';
    btn.classList.add('opacity-50', 'cursor-not-allowed');

    try {
        console.log('Scraping URL via server...');
        const response = await fetch('/scraper/scrape', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ url: url })
        });

        const result = await response.json();
        console.log('Server response:', result);

        if (result.success && result.data) {
            console.log('Success! Filling form fields...');

            // Fill form fields with scraped data
            if (result.data.name) {
                const nameField = document.getElementById('name');
                if (nameField) nameField.value = result.data.name;
            }
            if (result.data.description) {
                const descField = document.getElementById('description');
                if (descField) descField.value = result.data.description;
            }
            if (result.data.price) {
                const priceField = document.getElementById('price');
                if (priceField) priceField.value = result.data.price;
            }
            if (result.data.image_url) {
                const imgField = document.getElementById('image-input');
                if (imgField) imgField.value = result.data.image_url;
            }

            // Update image selector with new images
            if (result.data.images && result.data.images.length > 0) {
                window.imageSelector.loadExisting(result.data.image_url, result.data.images);
            }

            alert('Product information scraped successfully!');
        } else {
            console.error('Scraping failed:', result.error);
            alert('Failed to scrape URL: ' + (result.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error scraping URL:', error);
        alert('Error scraping URL: ' + error.message);
    } finally {
        // Re-enable button
        btn.disabled = false;
        btn.textContent = originalText;
        btn.classList.remove('opacity-50', 'cursor-not-allowed');
    }
});
</script>
{% endblock %}
