{% extends "base.html" %}

{% block title %}Add Item{% endblock %}

{% block head %}
<script src="{{ url_for('static', filename='js/scraper.js') }}"></script>
<script src="{{ url_for('static', filename='js/image-selector.js') }}"></script>
{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto">
    <h1 class="text-4xl font-bold mb-8">Add Item to Wishlist</h1>

    <div class="bg-gray-800 rounded-lg shadow-lg p-8">
        <div class="mb-6 p-4 bg-blue-900 rounded">
            <p class="text-sm text-gray-200">
                <strong>Tip:</strong> Paste a URL from Amazon, eBay, Walmart, or other shopping sites and click "Auto-Fill" to automatically extract product details!
            </p>
            <p class="text-xs text-gray-300 mt-2">
                <strong>Note:</strong> Etsy has bot protection and won't auto-fill. For Etsy items, just paste the URL and manually enter the item details below.
            </p>
        </div>

        <form method="POST" id="itemForm" class="space-y-4">
            {{ form.hidden_tag() }}

            <div>
                {{ form.url.label(class="block text-gray-200 font-semibold mb-2") }}
                {{ form.url(class="w-full px-4 py-2 bg-gray-700 border border-gray-600 text-gray-100 rounded-lg focus:ring-2 focus:ring-red-600 focus:border-red-600 placeholder-gray-400", id="url-input", placeholder="https://www.amazon.com/product...") }}
                <button type="button" id="scrape-btn" class="mt-2 bg-blue-600 text-white px-4 py-2 rounded text-sm hover:bg-blue-700">
                    Auto-Fill from URL
                </button>
                {% if form.url.errors %}
                    <p class="text-red-600 text-sm mt-1">{{ form.url.errors[0] }}</p>
                {% endif %}
            </div>

            <div>
                {{ form.name.label(class="block text-gray-200 font-semibold mb-2") }}
                {{ form.name(class="w-full px-4 py-2 bg-gray-700 border border-gray-600 text-gray-100 rounded-lg focus:ring-2 focus:ring-red-600 focus:border-red-600 placeholder-gray-400", id="name-input", required=true) }}
                {% if form.name.errors %}
                    <p class="text-red-600 text-sm mt-1">{{ form.name.errors[0] }}</p>
                {% endif %}
            </div>

            <div>
                {{ form.description.label(class="block text-gray-200 font-semibold mb-2") }}
                {{ form.description(class="w-full px-4 py-2 bg-gray-700 border border-gray-600 text-gray-100 rounded-lg focus:ring-2 focus:ring-red-600 focus:border-red-600 placeholder-gray-400", rows=3, id="description-input") }}
                {% if form.description.errors %}
                    <p class="text-red-600 text-sm mt-1">{{ form.description.errors[0] }}</p>
                {% endif %}
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    {{ form.price.label(class="block text-gray-200 font-semibold mb-2") }}
                    {{ form.price(class="w-full px-4 py-2 bg-gray-700 border border-gray-600 text-gray-100 rounded-lg focus:ring-2 focus:ring-red-600 focus:border-red-600 placeholder-gray-400", step="0.01", id="price-input") }}
                    {% if form.price.errors %}
                        <p class="text-red-600 text-sm mt-1">{{ form.price.errors[0] }}</p>
                    {% endif %}
                </div>

                <div>
                    {{ form.quantity.label(class="block text-gray-200 font-semibold mb-2") }}
                    {{ form.quantity(class="w-full px-4 py-2 bg-gray-700 border border-gray-600 text-gray-100 rounded-lg focus:ring-2 focus:ring-red-600 focus:border-red-600 placeholder-gray-400") }}
                    {% if form.quantity.errors %}
                        <p class="text-red-600 text-sm mt-1">{{ form.quantity.errors[0] }}</p>
                    {% endif %}
                </div>
            </div>

            <div>
                {{ form.image_url.label(class="block text-gray-200 font-semibold mb-2") }}
                {{ form.image_url(class="w-full px-4 py-2 bg-gray-700 border border-gray-600 text-gray-100 rounded-lg focus:ring-2 focus:ring-red-600 focus:border-red-600 placeholder-gray-400", id="image-input") }}
                {% if form.image_url.errors %}
                    <p class="text-red-600 text-sm mt-1">{{ form.image_url.errors[0] }}</p>
                {% endif %}
                <p class="text-xs text-gray-400 mt-1">
                    Enter an image URL manually, use Auto-Fill, or select from available images below.
                </p>
            </div>

            <!-- Image selector container -->
            <div id="image-selector-container"></div>

            <div class="flex gap-4">
                {{ form.submit(class="flex-1 bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 cursor-pointer") }}
                <a href="{{ url_for('wishlist.my_list') }}" class="flex-1 bg-gray-600 text-white py-3 rounded-lg font-semibold hover:bg-gray-700 text-center">
                    Cancel
                </a>
            </div>
        </form>
    </div>
</div>

<script>
// Initialize image selector
window.imageSelector = new ImageSelector('#image-selector-container');
window.imageSelector.init('#image-input');

document.getElementById('scrape-btn').addEventListener('click', async function() {
    const url = document.getElementById('url-input').value;
    if (!url) {
        alert('Please enter a URL first');
        return;
    }

    this.disabled = true;
    this.textContent = 'Loading...';

    try {
        console.log('Attempting client-side scraping...');
        const result = await scrapeProductUrl(url);

        if (result.success && result.data) {
            const data = result.data;
            console.log('Client-side scraping successful:', data);

            // Fill form fields
            if (data.name) document.getElementById('name-input').value = data.name;
            if (data.description) document.getElementById('description-input').value = data.description;
            if (data.price) document.getElementById('price-input').value = data.price;

            // Handle images with image selector
            if (data.images && data.images.length > 0) {
                window.imageSelector.setImages(data.images);
            } else if (data.image_url) {
                // Fallback to single image
                window.imageSelector.setImages([data.image_url]);
            } else {
                // No images found, show default
                window.imageSelector.setImages([]);
            }

            alert('Product information loaded successfully!');
        } else {
            throw new Error(result.error || 'Could not extract product information');
        }
    } catch (clientError) {
        console.warn('Client-side scraping failed:', clientError.message);
        console.log('Falling back to server-side scraping...');

        // Fallback to server-side scraping
        try {
            const response = await fetch('/scraper/scrape', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ url: url })
            });

            const serverResult = await response.json();

            if (response.ok && (serverResult.title || serverResult.name)) {
                console.log('Server-side scraping successful:', serverResult);

                // Fill form fields (server returns 'title' instead of 'name')
                if (serverResult.title || serverResult.name) {
                    document.getElementById('name-input').value = serverResult.title || serverResult.name;
                }
                if (serverResult.description) {
                    document.getElementById('description-input').value = serverResult.description;
                }
                if (serverResult.price) {
                    document.getElementById('price-input').value = serverResult.price;
                }

                // Handle images
                if (serverResult.images && serverResult.images.length > 0) {
                    window.imageSelector.setImages(serverResult.images);
                } else if (serverResult.image) {
                    window.imageSelector.setImages([serverResult.image]);
                } else {
                    window.imageSelector.setImages([]);
                }

                alert('Product information loaded successfully!');
            } else {
                throw new Error(serverResult.error || 'Could not extract product information');
            }
        } catch (serverError) {
            console.error('Both client and server scraping failed:', serverError);
            alert('Could not load product information from either method.\nPlease fill in manually.\n\nDetails: ' + clientError.message);
        }
    } finally {
        this.disabled = false;
        this.textContent = 'Auto-Fill from URL';
    }
});
</script>
{% endblock %}
